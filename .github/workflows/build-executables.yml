name: Build and Release Executables

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  # 任务一：在所有平台并行构建可执行文件
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            gui_asset_name: "stock-linux"
            cli_asset_name: "stock_quote_cli-linux"
            icon_arg: "" # PyInstaller 在 Linux 上不支持设置图标
          - os: macos-latest
            gui_asset_name: "stock-macos"
            cli_asset_name: "stock_quote_cli-macos"
            icon_arg: "--icon icon.png"
          - os: windows-latest
            gui_asset_name: "stock-windows.exe"
            cli_asset_name: "stock_quote_cli-windows.exe"
            icon_arg: "--icon icon.ico"

    steps:
    - name: Check out repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    # 仅在 Linux 环境下安装 xvfb 以提供虚拟图形环境
    - name: Install xvfb (Linux only)
      if: runner.os == 'Linux'
      run: sudo apt-get update && sudo apt-get install -y xvfb

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build GUI executable
      run: |
        # 在 Linux 上，使用 xvfb-run 来执行窗口化应用的打包
        PREFIX=""
        if [ "${{ runner.os }}" == "Linux" ]; then
          PREFIX="xvfb-run"
        fi
        $PREFIX pyinstaller --onefile --windowed --add-data "favorites.json:." --add-data "indexes.json:." --name "${{ matrix.gui_asset_name }}" ${{ matrix.icon_arg }} stock.py

    - name: Build CLI executable
      run: pyinstaller --onefile --add-data "favorites.json:." --add-data "indexes.json:." --name "${{ matrix.cli_asset_name }}" ${{ matrix.icon_arg }} stock_cli.py

    # 将生成的可执行文件重命名并移动到统一目录
    - name: Rename and organize executables
      run: |
        mkdir -p release-assets
        mv dist/${{ matrix.gui_asset_name }}* release-assets/
        mv dist/${{ matrix.cli_asset_name }}* release-assets/
      shell: bash

    # 将配置文件复制到发布资产目录
    - name: Copy configuration files
      run: |
        cp favorites.json release-assets/
        cp indexes.json release-assets/
      
    # 上传每个平台的构建产物
    - name: Upload platform build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: assets-${{ matrix.os }}
        path: release-assets/

  # 任务二：等待所有构建完成后，统一发布
  release:
    name: Create Unified Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      # 从之前的 build 任务中下载所有构建产物
      - name: Download all build artifacts
        uses: actions/download-artifact@v3
        with:
          path: downloaded-assets/

      # 整理所有平台的文件到一个统一的发布目录
      - name: Organize all assets
        run: |
          mkdir unified-release
          for dir in downloaded-assets/assets-*; do
            if [ -d "$dir" ]; then
              cp -r "$dir"/* unified-release/
            fi
          done

      # 将所有文件上传到 GitHub Release
      - name: Upload assets to release
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'release'
        with:
          files: unified-release/*