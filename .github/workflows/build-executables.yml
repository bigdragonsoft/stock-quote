name: Build and Release Executables

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  # 任务一：在所有平台并行构建可执行文件
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            gui_asset_name: "stock"
            cli_asset_name: "stock_quote_cli"
            icon_arg: "" # PyInstaller 在 Linux 上不支持设置图标
          - os: macos-latest
            gui_asset_name: "stock-macOS"
            cli_asset_name: "stock_quote_cli-macOS"
            icon_arg: "--icon icon.png"
          - os: windows-latest
            gui_asset_name: "stock-Windows"
            cli_asset_name: "stock_quote_cli-Windows"
            icon_arg: "--icon icon.ico"

    steps:
    - name: Check out repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    # 仅在 Linux 环境下安装 xvfb 以提供虚拟图形环境
    - name: Install xvfb (Linux only)
      if: runner.os == 'Linux'
      run: sudo apt-get update && sudo apt-get install -y xvfb

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build GUI executable
      run: |
        # 在 Linux 上，使用 xvfb-run 来执行窗口化应用的打包
        PREFIX=""
        if [ "${{ runner.os }}" == "Linux" ]; then
          PREFIX="xvfb-run"
        fi
        $PREFIX pyinstaller --onefile --windowed --add-data "favorites.json:." --add-data "indexes.json:." --name "${{ matrix.gui_asset_name }}" ${{ matrix.icon_arg }} stock.py

    - name: Build CLI executable
      run: pyinstaller --onefile --add-data "favorites.json:." --add-data "indexes.json:." --name "${{ matrix.cli_asset_name }}" ${{ matrix.icon_arg }} stock_cli.py

    # 将生成的 'dist' 目录中的所有文件作为一个构建产物上传
    - name: Upload build artifact
      uses: actions/upload-artifact@v3
      with:
        name: dist-${{ matrix.os }}
        path: dist/

  # 任务二：等待所有构建完成后，统一发布
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    # 'needs: build' 确保此任务在所有平台的 build 任务都成功后才开始
    needs: build
    permissions:
      contents: write
    steps:
      # 从之前的 build 任务中下载所有构建产物
      - name: Download all build artifacts
        uses: actions/download-artifact@v3
        with:
          # 将所有产物下载到 'artifacts' 目录下
          path: artifacts/

      # 将所有下载的产物文件上传到 GitHub Release
      - name: Upload assets to release
        uses: softprops/action-gh-release@v1
        with:
          # `files` 的通配符会匹配 artifacts/dist-ubuntu-latest/*, artifacts/dist-macos-latest/* 等所有文件
          files: artifacts/dist-*/*