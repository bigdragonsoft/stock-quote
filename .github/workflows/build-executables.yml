name: Build Executables

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            asset_name_suffix: ""
            icon_path: "icon.png"
          - os: macos-latest
            asset_name_suffix: "-macOS"
            icon_path: "icon.png" # PyInstaller on macOS can use .png
          - os: windows-latest
            asset_name_suffix: "-Windows.exe"
            icon_path: "icon.ico"

    steps:
    - name: Check out repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build GUI executable
      run: |
        pyinstaller --onefile --windowed --add-data "favorites.json:." --add-data "indexes.json:." --name "stock${{ matrix.asset_name_suffix }}" --icon "${{ matrix.icon_path }}" stock.py

    - name: Build CLI executable
      run: |
        pyinstaller --onefile --add-data "favorites.json:." --add-data "indexes.json:." --name "stock_quote_cli${{ matrix.asset_name_suffix }}" --icon "${{ matrix.icon_path }}" stock_cli.py

    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        files: dist/*
